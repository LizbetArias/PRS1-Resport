<div class="container mx-auto my-2 p-4">
    <header class="bg-white shadow mb-4">
        <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
            <h1 class="text-5xl font-extrabold text-blue-500">
                <span class="text-transparent bg-clip-text bg-gradient-to-r from-sky-400 to-blue-600">
                    Reportes Trimestrales
                </span>
            </h1>
        </div>
    </header>

    <div class="bg-white shadow-md rounded-lg p-6">
        <h2 class="text-2xl font-bold mb-4">Reportes Listado</h2>

        <!-- Filtros de búsqueda -->
        <div class="mb-4 flex justify-between items-center">
            <!-- Selección de trimestre -->
            <div class="form-floating mr-4">
                <select class="form-select" id="selectTrimester" (change)="onFilterChange()">
                    <option value="Enero-Marzo">Enero-Marzo</option>
                    <option value="Abril-Junio">Abril-Junio</option>
                    <option value="Julio-Septiembre">Julio-Septiembre</option>
                    <option value="Octubre-Diciembre">Octubre-Diciembre</option>
                </select>
                <label for="selectTrimester">Selecciona un Trimestre</label>
            </div>

            <!-- Filtro por año -->
            <div class="flex items-center mr-4">
                <label class="mr-2 font-semibold">Buscar Año:</label>
                <input type="number" class="border rounded px-2 py-1" (input)="onYearSearch($event)"
                    placeholder="Año" />
            </div>

            <!-- Botón Agregar Reporte -->
            <button class="bg-blue-600 text-white px-4 py-2 rounded mr-4" (click)="openModal()">
                Agregar Reporte
            </button>

            <!-- Estado Activo/Inactivo -->
            <div class="flex items-center">
                <label for="statusSwitcher" class="mr-3 text-lg font-semibold">Estado:</label>
                <div class="relative inline-block w-12 mr-2 align-middle select-none">
                    <input type="checkbox" id="statusSwitcher" [(ngModel)]="isActive" (change)="onFilterChange()"
                        class="toggle-input absolute block w-6 h-6 rounded-full bg-white border-2 appearance-none cursor-pointer" />
                    <span class="toggle-label block overflow-hidden h-6 rounded-full cursor-pointer"
                        [ngClass]="isActive ? 'bg-green-500' : 'bg-red-500'"></span>
                </div>
                <span class="ml-2 font-semibold" [ngClass]="isActive ? 'text-green-500' : 'text-red-500'">
                    {{ isActive ? 'Activo' : 'Inactivo' }}
                </span>
            </div>
        </div>

        <!-- Spinner de carga -->
        <div class="d-flex align-items-center" *ngIf="loading" style="margin-left: 10px; margin-top: 20px;">
            <strong role="status">Cargando...</strong>
            <div class="spinner-border ms-auto" aria-hidden="true"></div>
        </div>

        <!-- Tabla de reportes -->
        <div *ngIf="!loading" class="overflow-x-auto">
            <table class="min-w-full text-center border-separate" style="border-spacing: 0 10px;">
                <thead>
                    <tr>
                        <th class="px-6 py-3 text-lg font-semibold text-blue-900 bg-blue-100">Año</th>
                        <th class="px-6 py-3 text-lg font-semibold text-blue-900 bg-blue-100">Descripción</th>
                        <th class="px-6 py-3 text-lg font-semibold text-blue-900 bg-blue-100">Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    <tr *ngFor="let data of filteredReports">
                        <td class="px-6 py-4 bg-gray-100">{{ data.report.year }}</td>
                        <td class="px-6 py-4 bg-gray-100">
                            <div class="descripcion-texto">
                                {{ data.report.description }}
                            </div>
                        </td>
                        <td class="px-6 py-4 bg-gray-100">
                            <div class="acciones flex gap-2 justify-center items-center">
                                <button class="bg-yellow-500 text-white px-3 py-1 rounded"
                                    *ngIf="data.report.active === 'A'" (click)="openModal(data)">
                                    Editar
                                </button>
                                <button class="bg-red-500 text-white px-3 py-1 rounded"
                                    *ngIf="data.report.active === 'A'" (click)="delete(data.report.id)">
                                    Eliminar
                                </button>
                                <button class="bg-green-500 text-white px-3 py-1 rounded"
                                    *ngIf="data.report.active === 'I'" (click)="restore(data.report.id)">
                                    Restaurar
                                </button>
                                <button class="bg-gray-700 text-white px-3 py-1 rounded"
                                    *ngIf="data.report.active === 'A'">
                                    PDF
                                </button>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Modal -->
    <div *ngIf="isModalOpen" class="fixed inset-0 flex items-center justify-center bg-stone-900 bg-opacity-90 z-50">
        <div class="bg-white rounded-lg">
            <!-- Encabezado del Modal -->
            <div class="modal-header p-4 border-b">
                <h5 class="modal-title">{{ modalTitle }}</h5>
                <button type="button" class="btn-close" (click)="closeModal()">&times;</button>
            </div>
            <div class="modal-body p-4" style="max-height: 400px; overflow-y: auto;">
                <form [formGroup]="reporteForm" class="was-validated">
                    <!-- Información general -->
                    <div class="mb-3">
                        <label for="trimestre" class="form-label">Selecciona Un Trimestre</label>
                        <select class="form-select" id="trimestre" formControlName="trimestre" required>
                            <option selected disabled value="">Selecciona un Trimestre</option>
                            <option *ngFor="let trimestre of trimestres" [value]="trimestre">{{ trimestre }}</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="year" class="form-label">Año</label>
                        <input type="number" class="form-control" id="year" formControlName="year" required>
                        <div *ngIf="reporteForm.get('year')?.invalid && reporteForm.get('year')?.touched"
                            class="text-danger">
                            El año es obligatorio y debe ser un número válido.
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="descripcion" class="form-label">Descripción</label>
                        <textarea class="form-control" id="descripcion" formControlName="descripcion" rows="2"
                            required></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="cronograma" class="form-label">Cronograma (Opcional)</label>
                        <input type="file" class="form-control" id="cronograma" (change)="validarCronograma($event)">
                        <div class="invalid-feedback" *ngIf="cronogramaError">{{ cronogramaError }}</div>

                        <!-- Mostrar nombre de la imagen y el ícono -->
                        <div *ngIf="cronograma" class="mt-2 d-flex align-items-center">
                            <span class="badge bg-success me-1">{{ cronograma.name }} <button type="button"
                                    class="btn btn-succes fw-bold text-light" (click)="verCronograma()">
                                    <i class="bi bi-eye"></i> Ver
                                </button></span>
                        </div>
                    </div>

                    <!-- Lista dinámica de talleres -->
                    <div class="talleres-sections">
                        <div *ngFor="let taller of talleres.controls; let i = index" class="card mb-3">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <span>Taller {{ i + 1 }}</span>
                                <button type="button" class="btn btn-danger btn-sm"
                                    (click)="eliminarTaller(i)">Eliminar</button>
                            </div>
                            <div class="card-body" [formGroup]="getTallerFormGroup(i)">
                                <div class="mb-3">
                                    <label for="nombreTaller{{ i }}" class="form-label">Nombre del Taller</label>
                                    <input type="text" class="form-control" id="nombreTaller{{ i }}"
                                        formControlName="nombre" required>
                                </div>
                                <div class="mb-3">
                                    <label for="descripcionTaller{{ i }}" class="form-label">Descripción
                                        (Opcional)</label>
                                    <textarea class="form-control" id="descripcionTaller{{ i }}"
                                        formControlName="descripcion" rows="2"></textarea>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Imágenes</label>
                                    <input type="file" class="form-control" (change)="cargarImagenes($event, i)"
                                        multiple required>
                                </div>
                                <div class="mt-2">
                                    <span *ngFor="let img of imagenesTalleres[i]; let j = index"
                                        class="badge bg-secondary me-1 mb-2">
                                        {{ 'Imagen ' + (j + 1) }}
                                        <button type="button" class="btn btn-secondary btn-sm fw-bold"
                                            (click)="verImagenTaller(img)">
                                            <i class="bi bi-eye"></i> Ver
                                        </button>
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="text-end mt-3">
                        <button type="button" class="btn btn-primary" (click)="agregarTaller()">Agregar Taller</button>
                    </div>
                </form>
            </div>

            <!-- Pie del Modal -->
            <div class="modal-footer p-4">
                <button type="button" class="btn btn-gray" (click)="closeModal()">Cerrar</button>
                <button type="button" class="btn btn-primary" (click)="guardarReporte()">
                    {{ isEditMode ? 'Actualizar' : 'Guardar' }}
                </button>
            </div>
        </div>
    </div>
</div>